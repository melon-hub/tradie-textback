#!/bin/bash

# Secure Supabase Database Push
# Pushes migrations to Supabase using environment variables

set -e

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Change to project directory
cd "$PROJECT_DIR"

# Check if .env.local exists
if [ ! -f ".env.local" ]; then
    echo "‚ùå Error: .env.local file not found in project root"
    echo "   Please ensure your environment file exists with PGPASSWORD"
    exit 1
fi

# Source environment variables
source .env.local

# Verify required variables are set
if [ -z "$PGPASSWORD" ]; then
    echo "‚ùå Error: PGPASSWORD not found in .env.local"
    exit 1
fi

if [ -z "$SUPABASE_PROJECT_ID" ]; then
    echo "‚ùå Error: SUPABASE_PROJECT_ID not found in .env.local"
    exit 1
fi

echo "üîÑ Pushing database migrations to Supabase..."
echo "   Project: $SUPABASE_PROJECT_ID"

# Push migrations
supabase db push --password "$PGPASSWORD"

echo "‚úÖ Database migrations pushed successfully"