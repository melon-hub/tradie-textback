#!/bin/bash

# Secure Supabase Types Generator
# Generates TypeScript types from Supabase database

set -e

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Change to project directory
cd "$PROJECT_DIR"

# Check if .env.local exists
if [ ! -f ".env.local" ]; then
    echo "❌ Error: .env.local file not found in project root"
    echo "   Please ensure your environment file exists with PGPASSWORD"
    exit 1
fi

# Source environment variables
source .env.local

# Verify required variables are set
if [ -z "$PGPASSWORD" ]; then
    echo "❌ Error: PGPASSWORD not found in .env.local"
    exit 1
fi

if [ -z "$SUPABASE_PROJECT_ID" ]; then
    echo "❌ Error: SUPABASE_PROJECT_ID not found in .env.local"
    exit 1
fi

echo "🔄 Generating TypeScript types from Supabase..."
echo "   Project: $SUPABASE_PROJECT_ID"

# Generate types
supabase gen types typescript --password "$PGPASSWORD" > src/types/database.types.ts

echo "✅ TypeScript types generated successfully at src/types/database.types.ts"